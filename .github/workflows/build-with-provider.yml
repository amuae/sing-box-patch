name: Build sing-box with Provider Support

on:
  workflow_dispatch:
    inputs:
      upstream_repo:
        description: 'ä¸Šæ¸¸ä»“åº“ (é»˜è®¤: SagerNet/sing-box)'
        required: false
        default: 'SagerNet/sing-box'
        type: string
      upstream_ref:
        description: 'ä¸Šæ¸¸åˆ†æ”¯æˆ–æ ‡ç­¾ (é»˜è®¤: dev-next)'
        required: false
        default: 'dev-next'
        type: string
      version_suffix:
        description: 'ç‰ˆæœ¬åŽç¼€ (é»˜è®¤: -provider)'
        required: false
        default: '-provider'
        type: string
      build_platforms:
        description: 'æž„å»ºå¹³å°'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - linux-amd64
          - linux-arm64
          - windows-amd64
          - android-arm64

env:
  GO_VERSION: '1.23.1'

permissions:
  contents: write

jobs:
  prepare:
    name: å‡†å¤‡æºç å’Œåº”ç”¨è¡¥ä¸
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit: ${{ steps.prepare.outputs.commit }}
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“ (è¡¥ä¸ä»“åº“)
        uses: actions/checkout@v4
        with:
          path: 'patches-repo'
          
      - name: æ£€å‡ºä¸Šæ¸¸ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.upstream_repo || 'SagerNet/sing-box' }}
          ref: ${{ github.event.inputs.upstream_ref || 'dev-next' }}
          path: 'upstream'
          fetch-depth: 0
          
      - name: è®¾ç½®GoçŽ¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          
      - name: èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          cd upstream
          
          # å°è¯•èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
          if [ -f cmd/internal/read_tag/main.go ]; then
            VERSION=$(go run ./cmd/internal/read_tag --ci --nightly 2>/dev/null || echo "")
          fi
          
          # å¦‚æžœèŽ·å–å¤±è´¥ï¼Œæž„é€ ç‰ˆæœ¬å·
          if [ -z "$VERSION" ]; then
            BRANCH="${{ github.event.inputs.upstream_ref || 'dev-next' }}"
            COMMIT=$(git rev-parse --short HEAD)
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            VERSION="${BRANCH}-${COMMIT}-${TIMESTAMP}"
          fi
          
          VERSION="${VERSION}${{ github.event.inputs.version_suffix || '-provider' }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ ç”Ÿæˆç‰ˆæœ¬å·: $VERSION"
          
      - name: åº”ç”¨Providerè¡¥ä¸
        id: prepare
        run: |
          cd upstream
          COMMIT=$(git rev-parse HEAD)
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ ä¸Šæ¸¸æäº¤: $COMMIT"
          
          # å¤åˆ¶è¡¥ä¸è„šæœ¬
          cp ../patches-repo/apply-patches.sh ./
          cp -r ../patches-repo/patches ./
          
          # åº”ç”¨è¡¥ä¸
          echo "ðŸ”§ åº”ç”¨Provideræ”¯æŒè¡¥ä¸..."
          chmod +x apply-patches.sh
          ./apply-patches.sh
          
          # éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "ðŸ” éªŒè¯è¡¥ä¸åº”ç”¨ç»“æžœ..."
          if [ -f adapter/provider.go ]; then
            echo "âœ… adapter/provider.go å­˜åœ¨"
          else
            echo "âŒ adapter/provider.go ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ -d provider ]; then
            echo "âœ… provider/ ç›®å½•å­˜åœ¨"
            echo "ðŸ“ Provideræ–‡ä»¶: $(find provider -name "*.go" | wc -l) ä¸ª"
          else
            echo "âŒ provider/ ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "ðŸŽ‰ è¡¥ä¸åº”ç”¨å®Œæˆ!"
          
      - name: ç”Ÿæˆæž„å»ºçŸ©é˜µ
        id: matrix
        run: |
          PLATFORMS="${{ github.event.inputs.build_platforms || 'all' }}"
          
          if [ "$PLATFORMS" = "all" ]; then
            MATRIX='[
              {"name": "linux-amd64", "os": "linux", "arch": "amd64"},
              {"name": "linux-arm64", "os": "linux", "arch": "arm64"},
              {"name": "windows-amd64", "os": "windows", "arch": "amd64"},
              {"name": "android-arm64", "os": "android", "arch": "arm64", "ndk": "aarch64-linux-android21"}
            ]'
          else
            case "$PLATFORMS" in
              "linux-amd64")
                MATRIX='[{"name": "linux-amd64", "os": "linux", "arch": "amd64"}]'
                ;;
              "linux-arm64")
                MATRIX='[{"name": "linux-arm64", "os": "linux", "arch": "arm64"}]'
                ;;
              "windows-amd64")
                MATRIX='[{"name": "windows-amd64", "os": "windows", "arch": "amd64"}]'
                ;;
              "android-arm64")
                MATRIX='[{"name": "android-arm64", "os": "android", "arch": "arm64", "ndk": "aarch64-linux-android21"}]'
                ;;
            esac
          fi
          
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ æž„å»ºçŸ©é˜µ: $MATRIX"
          
      - name: ä¸Šä¼ å‡†å¤‡å¥½çš„æºç 
        uses: actions/upload-artifact@v4
        with:
          name: prepared-source
          path: upstream/
          retention-days: 1

  build:
    name: æž„å»º ${{ matrix.platform.name }}
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      matrix:
        platform: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: è®¾ç½®GoçŽ¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          
      - name: ä¸‹è½½å‡†å¤‡å¥½çš„æºç 
        uses: actions/download-artifact@v4
        with:
          name: prepared-source
          path: ./
          
      - name: è®¾ç½®Android NDK
        if: matrix.platform.os == 'android'
        run: |
          # å®‰è£…Android NDK
          sudo apt-get update -qq
          sudo apt-get install -y wget unzip
          
          # ä¸‹è½½å¹¶å®‰è£…NDK
          NDK_VERSION="r25c"
          wget -q https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip
          unzip -q android-ndk-${NDK_VERSION}-linux.zip
          export ANDROID_NDK_ROOT="$(pwd)/android-ndk-${NDK_VERSION}"
          echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
          echo "NDK_CC=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.platform.ndk }}-clang" >> $GITHUB_ENV
          
      - name: æž„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
        run: |
          set -euo pipefail
          
          # æž„å»ºæ ‡ç­¾
          BUILD_TAGS="with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale"
          
          # ç‰ˆæœ¬ä¿¡æ¯
          VERSION="${{ needs.prepare.outputs.version }}"
          LDFLAGS="-s -w -buildid= -X github.com/sagernet/sing-box/constant.Version=$VERSION"
          
          mkdir -p dist
          
          echo "ðŸ”¨ å¼€å§‹æž„å»º ${{ matrix.platform.name }}..."
          
          if [ "${{ matrix.platform.os }}" = "android" ]; then
            # Androidæž„å»º
            export CGO_ENABLED=1
            export CC="${{ env.NDK_CC }}"
            export CXX="${{ env.NDK_CC }}++"
            export GOOS=android
            export GOARCH=${{ matrix.platform.arch }}
            
            echo "ðŸ“± Androidæž„å»ºé…ç½®:"
            echo "   CC: $CC"
            echo "   GOOS: $GOOS"
            echo "   GOARCH: $GOARCH"
            
            go build -v -trimpath -ldflags "$LDFLAGS" -tags "$BUILD_TAGS" \
              -o dist/sing-box ./cmd/sing-box
          else
            # å…¶ä»–å¹³å°æž„å»º
            export CGO_ENABLED=0
            export GOOS=${{ matrix.platform.os }}
            export GOARCH=${{ matrix.platform.arch }}
            
            echo "ðŸ–¥ï¸ ${{ matrix.platform.os }}æž„å»ºé…ç½®:"
            echo "   GOOS: $GOOS"
            echo "   GOARCH: $GOARCH"
            
            go build -v -trimpath -ldflags "$LDFLAGS" -tags "$BUILD_TAGS" \
              -o dist/sing-box ./cmd/sing-box
          fi
          
          # éªŒè¯æž„å»ºç»“æžœ
          if [ -f dist/sing-box ]; then
            echo "âœ… æž„å»ºæˆåŠŸ"
            ls -la dist/sing-box
            file dist/sing-box || true
          else
            echo "âŒ æž„å»ºå¤±è´¥"
            exit 1
          fi
          
      - name: æ‰“åŒ…äºŒè¿›åˆ¶æ–‡ä»¶
        run: |
          cd dist
          
          # åˆ›å»ºå‘å¸ƒåŒ…
          PACKAGE_NAME="sing-box-${{ needs.prepare.outputs.version }}-${{ matrix.platform.name }}"
          mkdir -p "$PACKAGE_NAME"
          
          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          if [ "${{ matrix.platform.os }}" = "windows" ]; then
            cp sing-box "$PACKAGE_NAME/sing-box.exe"
          else
            cp sing-box "$PACKAGE_NAME/"
          fi
          
          # å¤åˆ¶è®¸å¯è¯
          if [ -f ../LICENSE ]; then
            cp ../LICENSE "$PACKAGE_NAME/"
          fi
          
          # åˆ›å»ºREADME
          cat > "$PACKAGE_NAME/README.md" << EOF
          # sing-box with Provider Support
          
          Version: ${{ needs.prepare.outputs.version }}
          Platform: ${{ matrix.platform.name }}
          Build Date: $(date -u)
          
          ## Features
          - Remote subscription provider
          - Local file provider  
          - Inline provider
          - Health check and auto-update
          - Enhanced selector/urltest groups
          
          ## Usage
          ./sing-box run -c config.json
          EOF
          
          # åˆ›å»ºåŽ‹ç¼©åŒ…
          if [ "${{ matrix.platform.os }}" = "windows" ]; then
            zip -r "${PACKAGE_NAME}.zip" "$PACKAGE_NAME"
            rm -rf "$PACKAGE_NAME"
            echo "ðŸ“¦ åˆ›å»º: ${PACKAGE_NAME}.zip"
          else
            tar -czvf "${PACKAGE_NAME}.tar.gz" "$PACKAGE_NAME"
            rm -rf "$PACKAGE_NAME"
            echo "ðŸ“¦ åˆ›å»º: ${PACKAGE_NAME}.tar.gz"
          fi
          
      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.platform.name }}
          path: dist/*.tar.gz dist/*.zip
          if-no-files-found: error

  release:
    name: åˆ›å»ºRelease
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: success()
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          
      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release
          find artifacts -name "*.tar.gz" -o -name "*.zip" | while read -r file; do
            cp "$file" release/
          done
          
          echo "ðŸ“¦ å‘å¸ƒæ–‡ä»¶:"
          ls -la release/
          
      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        run: |
          cat > release_notes.md << EOF
          ## ðŸš€ sing-box with Provider Support
          
          ### ðŸ“‹ æž„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬**: \`${{ needs.prepare.outputs.version }}\`
          - **ä¸Šæ¸¸ä»“åº“**: \`${{ github.event.inputs.upstream_repo || 'SagerNet/sing-box' }}\`
          - **åˆ†æ”¯/æ ‡ç­¾**: \`${{ github.event.inputs.upstream_ref || 'dev-next' }}\`
          - **æäº¤**: \`${{ needs.prepare.outputs.commit }}\`
          - **æž„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ### ðŸ”§ å¢žå¼ºåŠŸèƒ½
          - âœ… **Provideræ”¯æŒ**: è¿œç¨‹/æœ¬åœ°/å†…è”æä¾›å•†
          - âœ… **å¥åº·ç›‘æŽ§**: è‡ªåŠ¨èŠ‚ç‚¹å¥åº·æ£€æŸ¥
          - âœ… **è‡ªåŠ¨æ›´æ–°**: å®šæ—¶è®¢é˜…æ›´æ–°
          - âœ… **å¢žå¼ºç»„**: æ”¯æŒProviderçš„Selector/URLTestç»„
          - âœ… **é…ç½®æ‰©å±•**: æ‰©å±•é€‰é¡¹å’ŒéªŒè¯
          
          ### ðŸ“¦ å¯ç”¨å¹³å°
          - **Linux**: AMD64, ARM64
          - **Windows**: AMD64
          - **Android**: ARM64
          
          ### ðŸ› ï¸ æž„å»ºé…ç½®
          - **Goç‰ˆæœ¬**: ${{ env.GO_VERSION }}
          - **æž„å»ºæ ‡ç­¾**: \`with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale\`
          - **ä¼˜åŒ–**: åŽ‹ç¼©äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒåŽ»é™¤è°ƒè¯•ä¿¡æ¯
          
          ### ðŸ“š ä½¿ç”¨è¯´æ˜Ž
          ä¸‹è½½å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…ï¼Œè§£åŽ‹åŽå³å¯ä½¿ç”¨ã€‚
          
          ---
          > ðŸ¤– **è‡ªåŠ¨æž„å»º**  
          > æ­¤å‘å¸ƒç‰ˆæœ¬åŸºäºŽä¸Šæ¸¸æºç è‡ªåŠ¨æž„å»ºï¼Œé›†æˆäº†Provideræ”¯æŒåŠŸèƒ½ã€‚
          EOF
          
      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.version }}
          name: "sing-box ${{ needs.prepare.outputs.version }}"
          body_path: release_notes.md
          files: release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    name: æ¸…ç†çŽ¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [prepare, build, release]
    if: always()
    steps:
      - name: æ¸…ç†Artifacts
        uses: geekyeggo/delete-artifact@v4
        with:
          name: |
            prepared-source
            build-linux-amd64
            build-linux-arm64
            build-windows-amd64
            build-android-arm64
          failOnError: false
          
      - name: æž„å»ºæ€»ç»“
        run: |
          echo "## ðŸŽ‰ æž„å»ºæµç¨‹å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ æž„å»ºè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¸Šæ¸¸**: ${{ github.event.inputs.upstream_repo || 'SagerNet/sing-box' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.event.inputs.upstream_ref || 'dev-next' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹³å°**: ${{ github.event.inputs.build_platforms || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— å¿«é€Ÿé“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“¦ Releaseé¡µé¢](https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ”§ Provideræ–‡æ¡£](https://github.com/${{ github.repository }}#provider-support)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **çŽ¯å¢ƒå·²æ¸…ç†ï¼Œæž„å»ºäº§ç‰©å·²ä¿å­˜åˆ°Release**" >> $GITHUB_STEP_SUMMARY